{% extends 'admin_panel/base_admin.html' %}
{% block title %}API Keys - Admin{% endblock %}
{% block page_title %}API Keys{% endblock %}
{% block page_description %}Gerencie as chaves de acesso às APIs dos sites.{% endblock %}

{% block breadcrumb %}
<nav class="flex" aria-label="Breadcrumb">
    <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
            <a href="{% url 'admin_panel:dashboard' %}" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-home mr-2"></i>
                Dashboard
            </a>
        </li>
        <li>
            <div class="flex items-center">
                <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                <span class="text-gray-500 dark:text-gray-400">Sistema</span>
            </div>
        </li>
        <li>
            <div class="flex items-center">
                <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                <span class="text-gray-500 dark:text-gray-400">API Keys</span>
            </div>
        </li>
    </ol>
</nav>
{% endblock %}

{% block page_actions %}
<a href="{% url 'admin_panel:api_key_create' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
    <i class="fas fa-plus mr-2"></i>
    Nova Chave
</a>
{% endblock %}

{% block dashboard_content %}
<div class="space-y-6">
  <!-- Filtro -->
  <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
    <div class="px-4 py-5 sm:p-6">
      <form method="get" class="space-y-4 md:space-y-0 md:flex md:items-end md:space-x-4">
        <div class="flex-1">
          <label for="search" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Buscar</label>
          <input type="text" name="search" id="search" value="{{ search }}" placeholder="Prefixo, nome ou domínio" class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white sm:text-sm" />
        </div>
        <div>
          <label for="status" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Status</label>
          <select name="status" id="status" class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white sm:text-sm">
            <option value="" {% if not status %}selected{% endif %}>Todas</option>
            <option value="active" {% if status == 'active' %}selected{% endif %}>Ativas</option>
            <option value="revoked" {% if status == 'revoked' %}selected{% endif %}>Revogadas</option>
          </select>
        </div>
        <div class="flex space-x-2">
          <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <i class="fas fa-search mr-2"></i>Filtrar
          </button>
          {% if search %}
          <a href="{% url 'admin_panel:api_keys_list' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <i class="fas fa-times mr-2"></i>Limpar
          </a>
          {% endif %}
        </div>
      </form>
    </div>
  </div>

  <!-- Lista -->
  <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
    <div class="px-4 py-5 sm:p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
          Chaves ({{ keys|length }})
        </h3>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Prefixo</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Site</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Nome</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ativa</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Último Uso</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Criada</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ações</th>
            </tr>
          </thead>
          <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
            {% for k in keys %}
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
              <td class="px-6 py-4 whitespace-nowrap font-mono text-xs">{{ k.key_prefix }}...</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">{{ k.site.domain }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">{{ k.name|default:'-' }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                {% if k.is_active %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100">Sim</span>
                {% else %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100">Não</span>
                {% endif %}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500 dark:text-gray-400">{{ k.last_used_at|default:'-' }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500 dark:text-gray-400">{{ k.created_at }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                {% if k.is_active %}
                <form method="post" action="{% url 'admin_panel:api_key_revoke' k.id %}" onsubmit="return confirm('Revogar esta chave?');" class="inline">
                  {% csrf_token %}
                  <button class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300 mr-3" title="Revogar chave">
                    <i class="fas fa-ban"></i>
                  </button>
                </form>
                <button type="button" data-copy-prefix="{{ k.key_prefix }}" class="copy-prefix-btn text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300" title="Copiar prefixo da chave">
                  <i class="fas fa-copy"></i>
                </button>
                {% else %}
                <span class="text-gray-400 dark:text-gray-500 text-xs">Revogada</span>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">Nenhuma chave encontrada.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <p class="mt-4 text-xs text-gray-500 dark:text-gray-400">Máx. 200 chaves exibidas. Use o filtro para refinar.</p>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('click', function(e){
  const btn = e.target.closest('.copy-prefix-btn');
  if(!btn) return;
  const prefix = btn.getAttribute('data-copy-prefix');
  if(!prefix) return;
  navigator.clipboard.writeText(prefix + '.<TOKEN>')
    .then(()=>{
      const original = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-check"></i>';
      btn.classList.remove('text-blue-600','dark:text-blue-400');
      btn.classList.add('text-green-600','dark:text-green-400');
      setTimeout(()=>{
        btn.innerHTML = original;
        btn.classList.add('text-blue-600','dark:text-blue-400');
        btn.classList.remove('text-green-600','dark:text-green-400');
      }, 2000);
    })
    .catch(()=>alert('Não foi possível copiar.'));
});
</script>
{% endblock %}
