{% extends 'admin_panel/base_admin.html' %}
{% block title %}Gerar Chave de API - Admin{% endblock %}
{% block page_title %}Nova Chave de API{% endblock %}
{% block page_description %}Crie uma nova chave para integrações externas. Ela será exibida apenas uma vez.{% endblock %}

{% block breadcrumb %}
<nav class="flex" aria-label="Breadcrumb">
    <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
            <a href="{% url 'admin_panel:dashboard' %}" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-home mr-2"></i>
                Dashboard
            </a>
        </li>
        <li>
            <div class="flex items-center">
                <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                <span class="text-gray-500 dark:text-gray-400">Sistema</span>
            </div>
        </li>
        <li>
            <div class="flex items-center">
                <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                <a href="{% url 'admin_panel:api_keys_list' %}" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">API Keys</a>
            </div>
        </li>
        <li>
            <div class="flex items-center">
                <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                <span class="text-gray-500 dark:text-gray-400">Nova</span>
            </div>
        </li>
    </ol>
</nav>
{% endblock %}

{% block page_actions %}
<a href="{% url 'admin_panel:api_keys_list' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
    <i class="fas fa-list mr-2"></i>Voltar
</a>
{% endblock %}

{% block dashboard_content %}
<div class="space-y-6 max-w-3xl">
  <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
    <div class="px-4 py-5 sm:p-6">
      <form method="post" class="space-y-6">
        {% csrf_token %}
        <div>
          <label for="id_site" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Site</label>
          {{ form.site }}
        </div>
        <div>
          <label for="id_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nome (opcional)</label>
          {{ form.name }}
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Ex: Frontend Público, Integração X</p>
        </div>
        <div class="flex justify-end">
          <button class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <i class="fas fa-key mr-2"></i>Gerar Chave
          </button>
        </div>
      </form>
    </div>
  </div>

  {% if full_key %}
  <div class="bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-800 rounded-lg shadow p-4">
    <p class="text-sm font-semibold text-yellow-800 dark:text-yellow-200 flex items-center">
      <i class="fas fa-exclamation-triangle mr-2"></i>
      Chave Gerada (copie agora):
    </p>
    <div class="mt-3 relative">
      <pre id="generatedApiKey" class="p-3 bg-white dark:bg-gray-800 border border-yellow-300 dark:border-yellow-700 text-xs overflow-x-auto rounded font-mono">{{ full_key }}</pre>
      <button type="button" data-copy-target="generatedApiKey" class="copy-api-key-button absolute top-2 right-2 inline-flex items-center px-2 py-1 text-xs font-medium rounded bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-blue-500">
        <i class="fas fa-copy mr-1"></i>Copiar
      </button>
    </div>
    <p class="text-xs text-yellow-700 dark:text-yellow-300 mt-2">Esta chave não será exibida novamente. Armazene em local seguro.</p>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('click', function(e){
  const btn = e.target.closest('.copy-api-key-button');
  if(!btn) return;
  const targetId = btn.getAttribute('data-copy-target');
  const el = document.getElementById(targetId);
  if(!el) return;
  const text = el.innerText.trim();
  if(!text) return;
  navigator.clipboard.writeText(text).then(()=>{
    const original = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check mr-1"></i>Copiado';
    btn.classList.remove('bg-blue-600','hover:bg-blue-700');
    btn.classList.add('bg-green-600','hover:bg-green-700');
    setTimeout(()=>{
      btn.innerHTML = original;
      btn.classList.add('bg-blue-600','hover:bg-blue-700');
      btn.classList.remove('bg-green-600','hover:bg-green-700');
    }, 2500);
  }).catch(()=>{
    alert('Falha ao copiar para a área de transferência.');
  });
});
</script>
{% endblock %}
