{% extends 'user_panel/base.html' %}
{% load static %}

{% block user_title %}Configurações{% endblock %}

{% block extra_css %}
<style>
    .settings-card {
        @apply bg-white rounded-lg shadow-sm border border-gray-200 p-6;
    }
    .settings-section {
        @apply border-b border-gray-200 pb-6 mb-6 last:border-b-0 last:pb-0 last:mb-0;
    }
    .setting-item {
        @apply flex items-center justify-between py-3 border-b border-gray-100 last:border-b-0;
    }
    .setting-label {
        @apply text-sm font-medium text-gray-900;
    }
    .setting-description {
        @apply text-xs text-gray-500 mt-1;
    }
    .setting-control {
        @apply flex items-center space-x-2;
    }
</style>
{% endblock %}

{% block user_content %}
<div id="settings-app" class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <p class="text-gray-600">Gerencie suas preferências e configurações da conta</p>
    </div>

    <!-- Loading State -->
    <div v-if="loading" class="flex items-center justify-center py-12">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
        <span class="ml-3 text-gray-600">Carregando configurações...</span>
    </div>

    <!-- Settings Content -->
    <div v-else class="space-y-6">
        <!-- Category Tabs -->
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8">
                <button 
                    v-for="category in categories" 
                    :key="category.key"
                    @click="activeCategory = category.key"
                    :class="[
                        'py-2 px-1 border-b-2 font-medium text-sm transition-colors duration-200',
                        activeCategory === category.key 
                            ? 'border-primary-500 text-primary-600' 
                            : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                    ]"
                >
                    <i :class="category.icon" class="mr-2"></i>
                    {{ category.name }}
                </button>
            </nav>
        </div>

        <!-- Settings Cards -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- User Settings Card -->
            <div v-if="activeCategory === 'user' || activeCategory === 'all'" class="settings-card">
                <div class="settings-section">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-user mr-2 text-primary-600"></i>
                        Configurações Pessoais
                    </h3>
                    
                    <div v-for="setting in userSettings" :key="setting.key" class="setting-item">
                        <div class="flex-1">
                            <div class="setting-label">{{ setting.name|default:setting.key }}</div>
                            <div v-if="setting.description" class="setting-description">{{ setting.description }}</div>
                        </div>
                        <div class="setting-control">
                            <!-- Boolean Setting -->
                            <label v-if="setting.setting_type === 'boolean'" class="relative inline-flex items-center cursor-pointer">
                                <input 
                                    type="checkbox" 
                                    :checked="setting.typed_value" 
                                    @change="updateSetting('user', setting.key, $event.target.checked)"
                                    class="sr-only peer"
                                >
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
                            </label>
                            
                            <!-- String/Text Setting -->
                            <input 
                                v-else-if="setting.setting_type === 'string'"
                                type="text" 
                                :value="setting.typed_value" 
                                @blur="updateSetting('user', setting.key, $event.target.value)"
                                @keyup.enter="updateSetting('user', setting.key, $event.target.value)"
                                class="block w-48 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
                            >
                            
                            <!-- Integer Setting -->
                            <input 
                                v-else-if="setting.setting_type === 'integer'"
                                type="number" 
                                :value="setting.typed_value" 
                                @blur="updateSetting('user', setting.key, parseInt($event.target.value))"
                                @keyup.enter="updateSetting('user', setting.key, parseInt($event.target.value))"
                                class="block w-32 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
                            >
                            
                            <!-- Float Setting -->
                            <input 
                                v-else-if="setting.setting_type === 'float'"
                                type="number" 
                                step="0.01"
                                :value="setting.typed_value" 
                                @blur="updateSetting('user', setting.key, parseFloat($event.target.value))"
                                @keyup.enter="updateSetting('user', setting.key, parseFloat($event.target.value))"
                                class="block w-32 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
                            >
                            
                            <!-- Select Setting -->
                            <select 
                                v-else-if="setting.setting_type === 'choice' && setting.choices"
                                :value="setting.typed_value" 
                                @change="updateSetting('user', setting.key, $event.target.value)"
                                class="block w-48 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
                            >
                                <option v-for="choice in setting.choices" :key="choice.value" :value="choice.value">
                                    {{ choice.label }}
                                </option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Account Settings Card -->
            <div v-if="(activeCategory === 'account' || activeCategory === 'all') && canManageAccount" class="settings-card">
                <div class="settings-section">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-building mr-2 text-primary-600"></i>
                        Configurações da Conta
                    </h3>
                    
                    <div v-for="setting in accountSettings" :key="setting.key" class="setting-item">
                        <div class="flex-1">
                            <div class="setting-label">{{ setting.name|default:setting.key }}</div>
                            <div v-if="setting.description" class="setting-description">{{ setting.description }}</div>
                        </div>
                        <div class="setting-control">
                            <!-- Similar controls as user settings -->
                            <label v-if="setting.setting_type === 'boolean'" class="relative inline-flex items-center cursor-pointer">
                                <input 
                                    type="checkbox" 
                                    :checked="setting.typed_value" 
                                    @change="updateSetting('account', setting.key, $event.target.checked)"
                                    class="sr-only peer"
                                >
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
                            </label>
                            
                            <input 
                                v-else-if="setting.setting_type === 'string'"
                                type="text" 
                                :value="setting.typed_value" 
                                @blur="updateSetting('account', setting.key, $event.target.value)"
                                @keyup.enter="updateSetting('account', setting.key, $event.target.value)"
                                class="block w-48 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
                            >
                        </div>
                    </div>
                </div>
            </div>

            <!-- Global Settings Card (Admin Only) -->
            <div v-if="(activeCategory === 'global' || activeCategory === 'all') && isAdmin" class="settings-card">
                <div class="settings-section">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-globe mr-2 text-primary-600"></i>
                        Configurações Globais
                    </h3>
                    
                    <div v-for="setting in globalSettings" :key="setting.key" class="setting-item">
                        <div class="flex-1">
                            <div class="setting-label">{{ setting.name|default:setting.key }}</div>
                            <div v-if="setting.description" class="setting-description">{{ setting.description }}</div>
                        </div>
                        <div class="setting-control">
                            <span v-if="!setting.is_editable" class="text-sm text-gray-500 italic">Somente leitura</span>
                            <label v-else-if="setting.setting_type === 'boolean'" class="relative inline-flex items-center cursor-pointer">
                                <input 
                                    type="checkbox" 
                                    :checked="setting.typed_value" 
                                    @change="updateSetting('global', setting.key, $event.target.checked)"
                                    class="sr-only peer"
                                >
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success/Error Messages -->
        <div v-if="message" class="fixed bottom-4 right-4 z-50">
            <div :class="[
                'px-4 py-3 rounded-md shadow-lg',
                message.type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : 'bg-red-100 text-red-800 border border-red-200'
            ]">
                <div class="flex items-center">
                    <i :class="message.type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'" class="mr-2"></i>
                    {{ message.text }}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Vue.js 3 -->
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            loading: true,
            activeCategory: 'user',
            userSettings: [],
            accountSettings: [],
            globalSettings: [],
            message: null,
            canManageAccount: {{ user.account_membership.can_manage_settings|yesno:'true,false' }},
            isAdmin: {{ user.is_staff|yesno:'true,false' }},
            categories: [
                { key: 'user', name: 'Pessoais', icon: 'fas fa-user' },
                { key: 'account', name: 'Conta', icon: 'fas fa-building' },
                { key: 'global', name: 'Globais', icon: 'fas fa-globe' }
            ]
        }
    },
    async mounted() {
        await this.loadSettings();
    },
    methods: {
        async loadSettings() {
            this.loading = true;
            try {
                // Load user settings
                const userResponse = await fetch('/api/settings/user/', {
                    credentials: 'same-origin',
                    headers: {
                        'X-CSRFToken': window.csrfToken
                    }
                });
                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    this.userSettings = userData.results || [];
                }

                // Load account settings if user can manage
                if (this.canManageAccount) {
                    const accountResponse = await fetch('/api/settings/account/', {
                        credentials: 'same-origin',
                        headers: {
                            'X-CSRFToken': window.csrfToken
                        }
                    });
                    if (accountResponse.ok) {
                        const accountData = await accountResponse.json();
                        this.accountSettings = accountData.results || [];
                    }
                }

                // Load global settings if admin
                if (this.isAdmin) {
                    const globalResponse = await fetch('/api/settings/global/', {
                        credentials: 'same-origin',
                        headers: {
                            'X-CSRFToken': window.csrfToken
                        }
                    });
                    if (globalResponse.ok) {
                        const globalData = await globalResponse.json();
                        this.globalSettings = globalData.results || [];
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar configurações:', error);
                this.showMessage('Erro ao carregar configurações', 'error');
            } finally {
                this.loading = false;
            }
        },

        async updateSetting(scope, key, value) {
            try {
                const response = await fetch(`/api/settings/${scope}/`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrfToken
                    },
                    body: JSON.stringify({
                        key: key,
                        value: value
                    })
                });

                if (response.ok) {
                    // Update local data
                    const settingsArray = scope === 'user' ? this.userSettings : 
                                        scope === 'account' ? this.accountSettings : this.globalSettings;
                    const setting = settingsArray.find(s => s.key === key);
                    if (setting) {
                        setting.typed_value = value;
                        setting.value = String(value);
                    }
                    this.showMessage('Configuração atualizada com sucesso', 'success');
                } else {
                    throw new Error('Falha ao atualizar configuração');
                }
            } catch (error) {
                console.error('Erro ao atualizar configuração:', error);
                this.showMessage('Erro ao atualizar configuração', 'error');
            }
        },

        showMessage(text, type) {
            this.message = { text, type };
            setTimeout(() => {
                this.message = null;
            }, 3000);
        }
    }
}).mount('#settings-app');
</script>
{% endblock %}