{% extends 'auth/base_auth.html' %}
{% load static %}

{% block auth_title %}Nova Senha{% endblock %}
{% block form_title %}Defina sua nova senha{% endblock %}
{% block form_subtitle %}Escolha uma senha forte para proteger sua conta{% endblock %}

{% block form_content %}

{% if validlink %}
<form method="post" class="space-y-6" id="passwordResetConfirmForm">
    {% csrf_token %}
    
    <div class="text-center mb-6">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 dark:bg-green-900 mb-4">
            <i class="fas fa-shield-alt text-green-600 dark:text-green-400"></i>
        </div>
        <p class="text-sm text-gray-600 dark:text-gray-400">
            Seu link de recuperação é válido. Defina uma nova senha segura abaixo.
        </p>
    </div>

    <div>
        <label for="new_password1" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Nova Senha
        </label>
        <input 
            type="password" 
            id="new_password1" 
            name="new_password1" 
            required 
            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
            placeholder="••••••••"
            autocomplete="new-password"
            autofocus
        >
        <div id="password-strength" class="mt-2 hidden">
            <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">Força da senha:</div>
            <div class="flex space-x-1">
                <div class="h-1 w-1/4 bg-gray-200 rounded strength-bar"></div>
                <div class="h-1 w-1/4 bg-gray-200 rounded strength-bar"></div>
                <div class="h-1 w-1/4 bg-gray-200 rounded strength-bar"></div>
                <div class="h-1 w-1/4 bg-gray-200 rounded strength-bar"></div>
            </div>
            <div id="password-feedback" class="mt-1 text-xs text-gray-600 dark:text-gray-400"></div>
        </div>
    </div>

    <div>
        <label for="new_password2" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Confirmar Nova Senha
        </label>
        <input 
            type="password" 
            id="new_password2" 
            name="new_password2" 
            required 
            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
            placeholder="••••••••"
            autocomplete="new-password"
        >
        <div id="password-match" class="mt-1 text-sm hidden"></div>
    </div>

    <!-- Password Requirements -->
    <div class="p-4 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Requisitos da senha:
        </h4>
        <ul class="text-xs text-gray-600 dark:text-gray-400 space-y-1">
            <li class="flex items-center" id="req-length">
                <i class="fas fa-times text-red-500 mr-2 w-3"></i>
                Pelo menos 8 caracteres
            </li>
            <li class="flex items-center" id="req-lowercase">
                <i class="fas fa-times text-red-500 mr-2 w-3"></i>
                Uma letra minúscula
            </li>
            <li class="flex items-center" id="req-uppercase">
                <i class="fas fa-times text-red-500 mr-2 w-3"></i>
                Uma letra maiúscula
            </li>
            <li class="flex items-center" id="req-number">
                <i class="fas fa-times text-red-500 mr-2 w-3"></i>
                Um número
            </li>
        </ul>
    </div>

    <button 
        type="submit" 
        id="submitBtn"
        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        disabled
    >
        <span class="flex items-center">
            <i class="fas fa-save mr-2"></i>
            Salvar Nova Senha
        </span>
    </button>
</form>

{% else %}
<!-- Invalid Link -->
<div class="text-center">
    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900 mb-4">
        <i class="fas fa-exclamation-triangle text-red-600 dark:text-red-400"></i>
    </div>
    
    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">
        Link Inválido ou Expirado
    </h3>
    
    <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">
        O link de recuperação de senha que você usou é inválido ou já expirou. 
        Links de recuperação são válidos por apenas 24 horas por motivos de segurança.
    </p>
    
    <div class="space-y-3">
        <a href="{% url 'password_reset' %}" 
           class="w-full inline-flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors">
            <i class="fas fa-redo mr-2"></i>
            Solicitar Novo Link
        </a>
        
        <a href="{% url 'login' %}" 
           class="w-full inline-flex justify-center py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>
            Voltar ao Login
        </a>
    </div>
</div>

<!-- Help Section for Invalid Link -->
<div class="mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
    <div class="flex">
        <div class="flex-shrink-0">
            <i class="fas fa-question-circle text-blue-400"></i>
        </div>
        <div class="ml-3">
            <h3 class="text-sm font-medium text-blue-800 dark:text-blue-200">
                Precisa de ajuda?
            </h3>
            <div class="mt-2 text-sm text-blue-700 dark:text-blue-300">
                <p>
                    Se você continuar tendo problemas para redefinir sua senha, 
                    entre em contato com nosso suporte em 
                    <a href="mailto:suporte@exemplo.com" class="font-medium underline">
                        suporte@exemplo.com
                    </a>
                </p>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block auth_footer %}
<div class="text-center space-y-4">
    {% if validlink %}
        <div class="text-sm text-gray-600 dark:text-gray-400">
            Lembrou da senha?
            <a href="{% url 'login' %}" class="font-medium text-primary-600 hover:text-primary-500 transition-colors">
                Voltar ao login
            </a>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block hero_title %}
    {% if validlink %}
        Quase lá!
    {% else %}
        Ops! Algo deu errado
    {% endif %}
{% endblock %}

{% block hero_subtitle %}
    {% if validlink %}
        Defina uma senha forte e volte a usar nossa plataforma
    {% else %}
        Vamos resolver isso rapidamente para você
    {% endif %}
{% endblock %}

{% block hero_features %}
    {% if validlink %}
        <div class="flex items-center space-x-3">
            <i class="fas fa-check-circle text-green-300"></i>
            <span>Link de recuperação válido</span>
        </div>
        <div class="flex items-center space-x-3">
            <i class="fas fa-check-circle text-green-300"></i>
            <span>Processo seguro e criptografado</span>
        </div>
        <div class="flex items-center space-x-3">
            <i class="fas fa-check-circle text-green-300"></i>
            <span>Acesso imediato após redefinição</span>
        </div>
        <div class="flex items-center space-x-3">
            <i class="fas fa-check-circle text-green-300"></i>
            <span>Suas informações estão protegidas</span>
        </div>
    {% else %}
        <div class="flex items-center space-x-3">
            <i class="fas fa-shield-alt text-blue-300"></i>
            <span>Links expiram por segurança</span>
        </div>
        <div class="flex items-center space-x-3">
            <i class="fas fa-clock text-blue-300"></i>
            <span>Válidos por apenas 24 horas</span>
        </div>
        <div class="flex items-center space-x-3">
            <i class="fas fa-redo text-blue-300"></i>
            <span>Fácil solicitar novo link</span>
        </div>
        <div class="flex items-center space-x-3">
            <i class="fas fa-headset text-blue-300"></i>
            <span>Suporte sempre disponível</span>
        </div>
    {% endif %}
{% endblock %}

{% block testimonial %}
    {% if validlink %}
        <blockquote class="text-center">
            <p class="text-lg italic opacity-90 mb-4">
                "O processo de redefinição é muito seguro. Me sinto confiante usando a plataforma."
            </p>
            <footer class="text-sm opacity-75">
                — Ana Costa, Usuária Premium
            </footer>
        </blockquote>
    {% else %}
        <blockquote class="text-center">
            <p class="text-lg italic opacity-90 mb-4">
                "O suporte é excelente. Resolveram meu problema rapidamente."
            </p>
            <footer class="text-sm opacity-75">
                — Roberto Lima, Cliente há 3 anos
            </footer>
        </blockquote>
    {% endif %}
{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    /* Password strength indicator */
    .password-weak .strength-bar:nth-child(1) { background-color: #ef4444; }
    .password-fair .strength-bar:nth-child(1),
    .password-fair .strength-bar:nth-child(2) { background-color: #f59e0b; }
    .password-good .strength-bar:nth-child(1),
    .password-good .strength-bar:nth-child(2),
    .password-good .strength-bar:nth-child(3) { background-color: #10b981; }
    .password-strong .strength-bar { background-color: #059669; }
    
    /* Form validation styles */
    .field-valid {
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    
    .field-invalid {
        border-color: #ef4444;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }
    
    /* Requirement check styles */
    .requirement-met {
        color: #10b981;
    }
    
    .requirement-met i {
        color: #10b981;
    }
    
    /* Success animation */
    .success-pulse {
        animation: successPulse 0.6s ease-in-out;
    }
    
    @keyframes successPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
</style>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('passwordResetConfirmForm');
    if (!form) return; // Exit if form doesn't exist (invalid link case)
    
    const password1Input = document.getElementById('new_password1');
    const password2Input = document.getElementById('new_password2');
    const submitBtn = document.getElementById('submitBtn');
    
    // Password requirements elements
    const reqLength = document.getElementById('req-length');
    const reqLowercase = document.getElementById('req-lowercase');
    const reqUppercase = document.getElementById('req-uppercase');
    const reqNumber = document.getElementById('req-number');
    
    let requirements = {
        length: false,
        lowercase: false,
        uppercase: false,
        number: false
    };
    
    // Password strength and requirements check
    password1Input.addEventListener('input', function() {
        const password = this.value;
        const strengthDiv = document.getElementById('password-strength');
        const feedback = document.getElementById('password-feedback');
        const bars = strengthDiv.querySelectorAll('.strength-bar');
        
        if (password.length > 0) {
            strengthDiv.classList.remove('hidden');
            
            // Check requirements
            requirements.length = password.length >= 8;
            requirements.lowercase = /[a-z]/.test(password);
            requirements.uppercase = /[A-Z]/.test(password);
            requirements.number = /\d/.test(password);
            
            // Update requirement indicators
            updateRequirement(reqLength, requirements.length);
            updateRequirement(reqLowercase, requirements.lowercase);
            updateRequirement(reqUppercase, requirements.uppercase);
            updateRequirement(reqNumber, requirements.number);
            
            // Calculate strength
            const metRequirements = Object.values(requirements).filter(Boolean).length;
            
            // Reset bars
            bars.forEach(bar => {
                bar.className = 'h-1 w-1/4 bg-gray-200 rounded strength-bar';
            });
            
            // Update strength indicator
            const strengthClasses = ['', 'password-weak', 'password-fair', 'password-good', 'password-strong'];
            const strengthTexts = ['', 'Fraca', 'Razoável', 'Boa', 'Forte'];
            const strengthColors = ['', 'text-red-600', 'text-yellow-600', 'text-green-600', 'text-green-700'];
            
            if (metRequirements > 0) {
                strengthDiv.className = strengthClasses[metRequirements] + ' mt-2';
                
                for (let i = 0; i < metRequirements; i++) {
                    if (metRequirements === 1) bars[i].classList.add('bg-red-500');
                    else if (metRequirements === 2) bars[i].classList.add('bg-yellow-500');
                    else if (metRequirements === 3) bars[i].classList.add('bg-green-500');
                    else if (metRequirements === 4) bars[i].classList.add('bg-green-600');
                }
                
                feedback.textContent = strengthTexts[metRequirements];
                feedback.className = `mt-1 text-xs ${strengthColors[metRequirements]}`;
            }
        } else {
            strengthDiv.classList.add('hidden');
            // Reset all requirements
            Object.keys(requirements).forEach(key => requirements[key] = false);
            updateRequirement(reqLength, false);
            updateRequirement(reqLowercase, false);
            updateRequirement(reqUppercase, false);
            updateRequirement(reqNumber, false);
        }
        
        checkFormValidity();
        checkPasswordMatch();
    });
    
    // Password confirmation
    password2Input.addEventListener('input', checkPasswordMatch);
    
    function updateRequirement(element, met) {
        const icon = element.querySelector('i');
        if (met) {
            element.classList.add('requirement-met');
            icon.className = 'fas fa-check text-green-500 mr-2 w-3';
            element.classList.add('success-pulse');
            setTimeout(() => element.classList.remove('success-pulse'), 600);
        } else {
            element.classList.remove('requirement-met');
            icon.className = 'fas fa-times text-red-500 mr-2 w-3';
        }
    }
    
    function checkPasswordMatch() {
        const password1 = password1Input.value;
        const password2 = password2Input.value;
        const matchDiv = document.getElementById('password-match');
        
        if (password2.length > 0) {
            if (password1 === password2) {
                password2Input.classList.add('field-valid');
                password2Input.classList.remove('field-invalid');
                matchDiv.textContent = 'Senhas coincidem';
                matchDiv.className = 'mt-1 text-sm text-green-600';
            } else {
                password2Input.classList.add('field-invalid');
                password2Input.classList.remove('field-valid');
                matchDiv.textContent = 'Senhas não coincidem';
                matchDiv.className = 'mt-1 text-sm text-red-600';
            }
        } else {
            password2Input.classList.remove('field-valid', 'field-invalid');
            matchDiv.className = 'mt-1 text-sm hidden';
        }
        
        checkFormValidity();
    }
    
    function checkFormValidity() {
        const allRequirementsMet = Object.values(requirements).every(Boolean);
        const passwordsMatch = password1Input.value === password2Input.value && password2Input.value.length > 0;
        
        if (allRequirementsMet && passwordsMatch) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }
    
    // Form submission
    form.addEventListener('submit', function(e) {
        const allRequirementsMet = Object.values(requirements).every(Boolean);
        const passwordsMatch = password1Input.value === password2Input.value;
        
        if (!allRequirementsMet || !passwordsMatch) {
            e.preventDefault();
            return;
        }
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Salvando...';
    });
});
</script>
{% endblock %}